{"ast":null,"code":"import _regeneratorRuntime from\"@babel/runtime/regenerator\";import _classCallCheck from\"@babel/runtime/helpers/classCallCheck\";import _createClass from\"@babel/runtime/helpers/createClass\";import _defineProperty from\"@babel/runtime/helpers/defineProperty\";import _objectWithoutProperties from\"@babel/runtime/helpers/objectWithoutProperties\";import _slicedToArray from\"@babel/runtime/helpers/slicedToArray\";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(source,true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(source).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}import API,{GATEWAY_URL}from\"../../utils/api\";import{debounce}from\"../../utils/throttle\";import{whereEq}from\"ramda\";function normalizeRawThingProperties(rawItem){var entries=Object.entries(rawItem);var normalized=entries.map(function(_ref){var _ref2=_slicedToArray(_ref,2),key=_ref2[0],value=_ref2[1];var links=value.links,rest=_objectWithoutProperties(value,[\"links\"]);return[key,_objectSpread({},rest,{link:value.links[0].href})];});return Object.fromEntries(normalized);}export var Thing=function(){function Thing(raw,updateCallback){var _this=this;_classCallCheck(this,Thing);this.fetchValues=function _callee(){var _ref3,data;return _regeneratorRuntime.async(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return _regeneratorRuntime.awrap(API.fetch(\"\"+GATEWAY_URL+_this.href+\"/properties\"));case 2:_ref3=_context.sent;data=_ref3.data;_this.onPropertyStatus(data);case 5:case\"end\":return _context.stop();}}});};this.onPropertyStatus=function(value){_this.values=_objectSpread({},_this.values,{},value);_this.updateCallback(_this);};this.debouncedFetch=debounce(250,function(_ref4){var _ref5=_slicedToArray(_ref4,2),key=_ref5[0],val=_ref5[1];API.updateProperty(\"\"+GATEWAY_URL+_this.href+\"/properties/\"+key,_defineProperty({},key,val));});this.updateThing=function(value){Object.entries(value).forEach(function(args){return _this.debouncedFetch(args);});_this.onPropertyStatus(value);};var normalizedProperties=normalizeRawThingProperties(raw.properties);this.title=raw.title;this.id=raw.id;this.href=raw.href;this.properties=normalizedProperties;this.base=raw.base;this.updateCallback=updateCallback;this.wsBackoff=1000;this.closingWs=false;this.connected=false;this.values={on:false,level:0,colorTemperature:0};this.initWebsocket();this.fetchValues();}_createClass(Thing,[{key:\"initWebsocket\",value:function initWebsocket(){var _this2=this;if(this.closingWs){return;}if(!this.hasOwnProperty(\"href\")){return;}var wsHref=new URL(this.href,this.base.replace(/^http/,\"ws\"));this.ws=new WebSocket(wsHref+\"?jwt=\"+API.jwt);this.ws.addEventListener(\"open\",function(){_this2.wsBackoff=1000;var msg={messageType:\"addEventSubscription\",data:{}};_this2.ws.send(JSON.stringify(msg));},{once:true});var debouncedPropertyStatusChangedCheck=debounce(1000,function(message){if(!whereEq(message,_this2.values)){_this2.onPropertyStatus(message);}});var onEvent=function onEvent(event){var message=JSON.parse(event.data);switch(message.messageType){case\"propertyStatus\":debouncedPropertyStatusChangedCheck(message.data);break;case\"event\":break;case\"connected\":_this2.onConnected(message.data);break;case\"error\":if(message.data.status===\"404 Not Found\"){console.log(\"Successfully removed Thing.\");cleanup();}break;}};var cleanup=function cleanup(){if(!_this2.ws)return;_this2.ws.removeEventListener(\"message\",onEvent);_this2.ws.removeEventListener(\"close\",cleanup);_this2.ws.removeEventListener(\"error\",cleanup);_this2.ws.close();_this2.ws=undefined;setTimeout(function(){_this2.wsBackoff*=2;if(_this2.wsBackoff>30000){_this2.wsBackoff=30000;}_this2.initWebsocket();},_this2.wsBackoff);};this.ws.addEventListener(\"message\",onEvent);this.ws.addEventListener(\"close\",cleanup);this.ws.addEventListener(\"error\",cleanup);}},{key:\"onConnected\",value:function onConnected(connected){this.connected=connected;}}]);return Thing;}();","map":{"version":3,"sources":["/home/rick/dev/cool-home/src/store/things/models.ts"],"names":["API","GATEWAY_URL","debounce","whereEq","normalizeRawThingProperties","rawItem","entries","Object","normalized","map","key","value","links","rest","link","href","fromEntries","Thing","raw","updateCallback","fetchValues","fetch","data","onPropertyStatus","values","debouncedFetch","val","updateProperty","updateThing","forEach","args","normalizedProperties","properties","title","id","base","wsBackoff","closingWs","connected","on","level","colorTemperature","initWebsocket","hasOwnProperty","wsHref","URL","replace","ws","WebSocket","jwt","addEventListener","msg","messageType","send","JSON","stringify","once","debouncedPropertyStatusChangedCheck","message","onEvent","event","parse","onConnected","status","console","log","cleanup","removeEventListener","close","undefined","setTimeout"],"mappings":"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","sourcesContent":["import {\n  ThingPropertiesRaw,\n  ThingModelProperties,\n  ThingModel,\n  ThingModelValues,\n  ThingRaw\n} from \"./interfaces\";\nimport API, { GATEWAY_URL } from \"../../utils/api\";\nimport { debounce } from \"../../utils/throttle\";\nimport { whereEq } from \"ramda\";\n\nexport type FetchData<T> = { loading: boolean; result?: T; error?: string };\n\nfunction normalizeRawThingProperties(\n  rawItem: ThingPropertiesRaw\n): Partial<ThingModelProperties> {\n  const entries = Object.entries(rawItem);\n  const normalized = entries.map(([key, value]) => {\n    const { links, ...rest } = value;\n    return [\n      key,\n      {\n        ...rest,\n        link: value.links[0].href\n      }\n    ];\n  });\n  return Object.fromEntries(normalized);\n}\n\nexport class Thing implements ThingModel {\n  id: string;\n  title: string;\n  href: string;\n  properties: Partial<ThingModelProperties>; // <== static properties that relate to values (e.g. minmax)\n  values: Partial<ThingModelValues>; // <== dynamic properties (e.g. currentValue)\n  closingWs: boolean;\n  base: string;\n  wsBackoff: number;\n  ws?: WebSocket;\n  connected: boolean;\n  updateCallback: (updatedThing: ThingModel) => void;\n  constructor(\n    raw: ThingRaw,\n    updateCallback: (updatedThing: ThingModel) => void\n  ) {\n    const normalizedProperties = normalizeRawThingProperties(raw.properties);\n    this.title = raw.title;\n    this.id = raw.id;\n    this.href = raw.href;\n    this.properties = normalizedProperties;\n    this.base = raw.base;\n    this.updateCallback = updateCallback;\n    this.wsBackoff = 1000;\n    this.closingWs = false;\n    this.connected = false;\n    // this.eventDescriptions = raw.events @TODO implement\n    this.values = {\n      on: false,\n      level: 0,\n      colorTemperature: 0\n    };\n\n    this.initWebsocket();\n    this.fetchValues();\n  }\n\n  fetchValues = async () => {\n    const { data } = await API.fetch<ThingModelValues>(\n      `${GATEWAY_URL}${this.href}/properties`\n    );\n    this.onPropertyStatus(data!);\n  };\n\n  onPropertyStatus = (value: Partial<ThingModelValues>) => {\n    this.values = {\n      ...this.values,\n      ...value\n    };\n    this.updateCallback(this);\n  };\n\n  debouncedFetch = debounce<[string, Partial<ThingModelValues>]>(\n    250,\n    ([key, val]) => {\n      API.updateProperty(`${GATEWAY_URL}${this.href}/properties/${key}`, {\n        [key]: val\n      });\n    }\n  );\n\n  updateThing = (value: Partial<ThingModelValues>) => {\n    Object.entries(value).forEach(args => this.debouncedFetch(args));\n    this.onPropertyStatus(value);\n  };\n\n  private initWebsocket() {\n    if (this.closingWs) {\n      return;\n    }\n\n    if (!this.hasOwnProperty(\"href\")) {\n      return;\n    }\n\n    const wsHref = new URL(this.href, this.base.replace(/^http/, \"ws\"));\n\n    this.ws = new WebSocket(`${wsHref}?jwt=${API.jwt}`);\n\n    // After the websocket is open, add subscriptions for all events.\n    this.ws.addEventListener(\n      \"open\",\n      () => {\n        // Reset the backoff period\n        this.wsBackoff = 1000;\n\n        // if (Object.keys(this.eventDescriptions).length == 0) {\n        //   return;\n        // }\n        const msg = {\n          messageType: \"addEventSubscription\",\n          data: {}\n        };\n        // for (const name in this.eventDescriptions) {\n        //   msg.data[name] = {};\n        // }\n        this.ws!.send(JSON.stringify(msg));\n      },\n      { once: true }\n    );\n\n    const debouncedPropertyStatusChangedCheck = debounce<\n      Partial<ThingModelValues>\n    >(1000, message => {\n      if (!whereEq(message, this.values)) {\n        this.onPropertyStatus(message);\n      }\n    });\n\n    const onEvent = (event: { data: string }) => {\n      const message = JSON.parse(event.data);\n\n      switch (message.messageType) {\n        case \"propertyStatus\":\n          debouncedPropertyStatusChangedCheck(message.data);\n          break;\n        case \"event\":\n          // this.onEvent(message.data);\n          break;\n        case \"connected\":\n          this.onConnected(message.data);\n          break;\n        case \"error\":\n          // status 404 means that the Thing already removed.\n          if (message.data.status === \"404 Not Found\") {\n            console.log(\"Successfully removed Thing.\");\n            cleanup();\n          }\n          break;\n      }\n    };\n\n    const cleanup = () => {\n      if (!this.ws) return;\n      this.ws.removeEventListener(\"message\", onEvent);\n      this.ws.removeEventListener(\"close\", cleanup);\n      this.ws.removeEventListener(\"error\", cleanup);\n      this.ws.close();\n      this.ws = undefined;\n\n      setTimeout(() => {\n        this.wsBackoff *= 2;\n        if (this.wsBackoff > 30000) {\n          this.wsBackoff = 30000;\n        }\n        this.initWebsocket();\n      }, this.wsBackoff);\n    };\n\n    this.ws.addEventListener(\"message\", onEvent);\n    this.ws.addEventListener(\"close\", cleanup);\n    this.ws.addEventListener(\"error\", cleanup);\n  }\n\n  onConnected(connected: boolean) {\n    this.connected = connected;\n  }\n}\n"]},"metadata":{},"sourceType":"module"}